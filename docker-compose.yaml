version: '3.8'
services:
  portainer_container:
    container_name: portainer
    image: portainer/portainer
    command: --no-analytics --ssl --sslcert /certs/${CERTIFICATE_FILE} --sslkey /certs/${CERTIFICATE_KEY}
    ports:
      - 127.0.0.1:${PORTAINER_PORT}:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CERTIFICATE_PATH}:/certs
      - ${PORTAINER_DATA_PATH}:/data
    networks:
      default:
        ipv4_address: ${PORTAINER_NETWORK_IP}
  php7_container:
    container_name: Php_${PHP7_VERSION}-fpm
    build:
      context: ${PATH_ROOT}/docker
      dockerfile: Dockerfile_php7
      args:
        USER_NAME: ${USER_NAME}
        USER_PASSWORD: ${USER_PASSWORD}
        WWW_USER_NAME: ${WWW_USER_NAME}
        WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
        WEB_USER_GROUP: ${WEB_USER_GROUP}
        WEB_PATH: ${WEB_PATH}
        PATH_ROOT: ${PATH_ROOT}
        TIMEZONE: ${TIMEZONE}
        PHP7_VERSION: ${PHP7_VERSION}
        PHP7_PORT_FPM: ${PHP7_PORT_FPM}
        PHP7_PORT_XDEBUG: ${PHP7_PORT_XDEBUG}
        PHP7_PATH_ROOT: ${PHP7_PATH_ROOT}
        PHP7_VH_NAME: ${PHP7_VH_NAME}
    environment:
      USER_NAME: ${USER_NAME}
      USER_PASSWORD: ${USER_PASSWORD}
      WWW_USER_NAME: ${WWW_USER_NAME}
      WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
      WEB_USER_GROUP: ${WEB_USER_GROUP}
      WEB_PATH: ${WEB_PATH}
      PATH_ROOT: ${PATH_ROOT}
      TIMEZONE: ${TIMEZONE}
      PHP7_VERSION: ${PHP7_VERSION}
      PHP7_PORT_FPM: ${PHP7_PORT_FPM}
      PHP7_PORT_XDEBUG: ${PHP7_PORT_XDEBUG}
      PHP7_PATH_ROOT: ${PHP7_PATH_ROOT}
      PHP7_VH_NAME: ${PHP7_VH_NAME}
    ports:
      - 127.0.0.1:${PHP7_PORT_FPM}:${PHP7_PORT_FPM}
      - ${PHP7_PORT_XDEBUG}:${PHP7_PORT_XDEBUG}
    volumes:
      - ${PATH_ROOT}:/home/${WWW_USER_NAME}/root
    networks:
      default:
        ipv4_address: ${PHP7_NETWORK_IP}
  apache_container:
    container_name: Apache_${APACHE_VERSION}
    build:
      context: ${PATH_ROOT}/docker
      dockerfile: Dockerfile_apache
      args:
        WWW_USER_NAME: ${WWW_USER_NAME}
        WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
        WEB_USER_GROUP: ${WEB_USER_GROUP}
        WEB_PATH: ${WEB_PATH}
        PATH_ROOT: ${PATH_ROOT}
        TIMEZONE: ${TIMEZONE}
        CERTIFICATE_FILE: ${CERTIFICATE_FILE}
        CERTIFICATE_KEY: ${CERTIFICATE_KEY}
        CERTIFICATE_CHAIN: ${CERTIFICATE_CHAIN}
        CERTIFICATE_PATH: ${CERTIFICATE_PATH}
        DOMAIN: ${DOMAIN}
        APACHE_VERSION: ${APACHE_VERSION}
        APACHE_PORT_HTTP: ${APACHE_PORT_HTTP}
        APACHE_PORT_HTTPS: ${APACHE_PORT_HTTPS}
        APACHE_PATH_ROOT: ${APACHE_PATH_ROOT}
        PHP7_PORT_FPM: ${PHP7_PORT_FPM}
        PHP7_VH_NAME: ${PHP7_VH_NAME}
        PORTAINER_PORT: ${PORTAINER_PORT}
        GITLAB_PORT_HTTP: ${GITLAB_PORT_HTTP}
        GITLAB_PORT_HTTPS: ${GITLAB_PORT_HTTPS}
    environment:
      WWW_USER_NAME: ${WWW_USER_NAME}
      WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
      WEB_USER_GROUP: ${WEB_USER_GROUP}
      WEB_PATH: ${WEB_PATH}
      PATH_ROOT: ${PATH_ROOT}
      TIMEZONE: ${TIMEZONE}
      CERTIFICATE_FILE: ${CERTIFICATE_FILE}
      CERTIFICATE_KEY: ${CERTIFICATE_KEY}
      CERTIFICATE_CHAIN: ${CERTIFICATE_CHAIN}
      CERTIFICATE_PATH: ${CERTIFICATE_PATH}
      DOMAIN: ${DOMAIN}
      APACHE_VERSION: ${APACHE_VERSION}
      APACHE_PORT_HTTP: ${APACHE_PORT_HTTP}
      APACHE_PORT_HTTPS: ${APACHE_PORT_HTTPS}
      APACHE_PATH_ROOT: ${APACHE_PATH_ROOT}
      PHP7_PORT_FPM: ${PHP7_PORT_FPM}
      PHP7_VH_NAME: ${PHP7_VH_NAME}
      PORTAINER_PORT: ${PORTAINER_PORT}
      GITLAB_PORT_HTTP: ${GITLAB_PORT_HTTP}
      GITLAB_PORT_HTTPS: ${GITLAB_PORT_HTTPS}
    ports:
      - ${APACHE_PORT_HTTP}:80
      - ${APACHE_PORT_HTTPS}:443
    volumes:
      - ${PATH_ROOT}:/home/${WWW_USER_NAME}/root
      - ${PATH_ROOT}:${APACHE_PATH_ROOT}/htdocs
    networks:
      default:
        ipv4_address: ${APACHE_NETWORK_IP}
  mysql_container:
    container_name: MySql_${MYSQL_VERSION}
    command: --sql_mode=""
    build:
      context: ${PATH_ROOT}/docker
      dockerfile: Dockerfile_mysql
      args:
        WWW_USER_NAME: ${WWW_USER_NAME}
        WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
        WEB_USER_GROUP: ${WEB_USER_GROUP}
        WEB_PATH: ${WEB_PATH}
        PATH_ROOT: ${PATH_ROOT}
        TIMEZONE: ${TIMEZONE}
        MYSQL_VERSION: ${MYSQL_VERSION}
        MYSQL_PORT: ${MYSQL_PORT}
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    environment:
      WWW_USER_NAME: ${WWW_USER_NAME}
      WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
      WEB_USER_GROUP: ${WEB_USER_GROUP}
      WEB_PATH: ${WEB_PATH}
      PATH_ROOT: ${PATH_ROOT}
      TIMEZONE: ${TIMEZONE}
      MYSQL_VERSION: ${MYSQL_VERSION}
      MYSQL_PORT: ${MYSQL_PORT}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - 127.0.0.1:${MYSQL_PORT}:3306
    volumes:
      - ${PATH_ROOT}:/home/${WWW_USER_NAME}/root
      - ${MYSQL_DATA_PATH}:/var/lib/mysql
    networks:
      default:
        ipv4_address: ${MYSQL_NETWORK_IP}
  postgresql_container:
    container_name: PostgreSql_${POSTGRES_VERSION}
    build:
      context: ${PATH_ROOT}/docker
      dockerfile: Dockerfile_postgresql
      args:
        WWW_USER_NAME: ${WWW_USER_NAME}
        WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
        WEB_USER_GROUP: ${WEB_USER_GROUP}
        WEB_PATH: ${WEB_PATH}
        PATH_ROOT: ${PATH_ROOT}
        TIMEZONE: ${TIMEZONE}
        POSTGRES_VERSION: ${POSTGRES_VERSION}
        POSTGRES_PORT: ${POSTGRES_PORT}
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    environment:
      WWW_USER_NAME: ${WWW_USER_NAME}
      WWW_USER_PASSWORD: ${WWW_USER_PASSWORD}
      WEB_USER_GROUP: ${WEB_USER_GROUP}
      WEB_PATH: ${WEB_PATH}
      PATH_ROOT: ${PATH_ROOT}
      TIMEZONE: ${TIMEZONE}
      POSTGRES_VERSION: ${POSTGRES_VERSION}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - 127.0.0.1:${POSTGRES_PORT}:5432
    volumes:
      - ${PATH_ROOT}:/home/${WWW_USER_NAME}/root
      - ${POSTGRES_DATA_PATH}:/var/lib/postgresql/data
    networks:
      default:
        ipv4_address: ${POSTGRES_NETWORK_IP}
  nodejs_container:
    container_name: NodeJs_${NODEJS_VERSION}
    build:
      context: ${PATH_ROOT}/docker
      dockerfile: Dockerfile_nodejs
      args:
        WWW_USER_NAME: ${WWW_USER_NAME}
        WEB_PATH: ${WEB_PATH}
        PATH_ROOT: ${PATH_ROOT}
        TIMEZONE: ${TIMEZONE}
        CERTIFICATE_FILE: ${CERTIFICATE_FILE}
        CERTIFICATE_KEY: ${CERTIFICATE_KEY}
        CERTIFICATE_CHAIN: ${CERTIFICATE_CHAIN}
        CERTIFICATE_PATH: ${CERTIFICATE_PATH}
        NODEJS_VERSION: ${NODEJS_VERSION}
        NODEJS_ENV: ${NODEJS_ENV}
        NODEJS_PORT_HTTP: ${NODEJS_PORT_HTTP}
        NODEJS_PORT_HTTPS: ${NODEJS_PORT_HTTPS}
        NODEJS_DIGEST_ENABLE: ${NODEJS_DIGEST_ENABLE}
    environment:
      WWW_USER_NAME: ${WWW_USER_NAME}
      WEB_PATH: ${WEB_PATH}
      PATH_ROOT: ${PATH_ROOT}
      TIMEZONE: ${TIMEZONE}
      CERTIFICATE_FILE: ${CERTIFICATE_FILE}
      CERTIFICATE_KEY: ${CERTIFICATE_KEY}
      CERTIFICATE_CHAIN: ${CERTIFICATE_CHAIN}
      CERTIFICATE_PATH: ${CERTIFICATE_PATH}
      NODEJS_VERSION: ${NODEJS_VERSION}
      NODEJS_ENV: ${NODEJS_ENV}
      NODEJS_PORT_HTTP: ${NODEJS_PORT_HTTP}
      NODEJS_PORT_HTTPS: ${NODEJS_PORT_HTTPS}
      NODEJS_DIGEST_ENABLE: ${NODEJS_DIGEST_ENABLE}
    ports:
      - 127.0.0.1:${NODEJS_PORT_HTTP}:${NODEJS_PORT_HTTP}
      - 127.0.0.1:${NODEJS_PORT_HTTPS}:${NODEJS_PORT_HTTPS}
    volumes:
      - ${PATH_ROOT}:/home/${WWW_USER_NAME}/root
    networks:
      default:
        ipv4_address: ${NODEJS_NETWORK_IP}
  gitlab_container:
    container_name: Gitlab_${GITLAB_VERSION}
    image: gitlab/gitlab-ce:${GITLAB_VERSION}
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.${DOMAIN}'
        git_data_dirs({'default' => {'path' => '/var/opt/gitlab/git-data'}})
        gitlab_rails['lfs_enabled'] = true
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_PORT_SSH}
        unicorn['worker_timeout'] = 60
        unicorn['worker_processes'] = 3
        nginx['listen_port'] = ${GITLAB_PORT_HTTPS}
        nginx['redirect_http_to_https'] = true
        nginx['ssl_certificate'] = "/etc/certificate/${CERTIFICATE_FILE}"
        nginx['ssl_certificate_key'] = "/etc/certificate/${CERTIFICATE_KEY}"
        letsencrypt['enable'] = false
    ports:
      - 127.0.0.1:${GITLAB_PORT_HTTP}:80
      - 127.0.0.1:${GITLAB_PORT_HTTPS}:443
      - 127.0.0.1:${GITLAB_PORT_SSH}:22
    volumes:
      - ${CERTIFICATE_PATH}:/etc/certificate
      - ${GITLAB_DATA_PATH}/log:/var/log/gitlab
      - ${GITLAB_DATA_PATH}/data:/etc/gitlab
      - ${GITLAB_DATA_PATH}/opt:/var/opt/gitlab
    networks:
      default:
        ipv4_address: ${GITLAB_NETWORK_IP}
networks:
  default:
    driver: ${NETWORK_DRIVER}
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUB}
#volumes:
#  home:
#    driver_opts:
#      type: none
#      device: /home
#      o: bind