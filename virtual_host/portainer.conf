<VirtualHost *:80>
    ServerAdmin ${WWW_USER_NAME}@${DOMAIN}
    ServerName portainer.${DOMAIN}
    ServerAlias portainer.${DOMAIN}

<Location />
ProxyPass http://127.0.0.1:9000/
ProxyPassReverse http://127.0.0.1:9000/
RequestHeader set X-Forwarded-Proto "http"
</Location>
<Location /api/websocket/>
ProxyPass http://127.0.0.1:9000/api/websocket/
ProxyPassReverse http://127.0.0.1:9000/api/websocket/
RewriteEngine on
RewriteCond %{HTTP:Upgrade} =websocket
RewriteRule /(.*) ws://127.0.0.1:9000/$1 [P,QSA,L]
RewriteCond %{HTTP:Upgrade} !=websocket
RewriteRule /(.*) http://127.0.0.1:9000/$1 [P,QSA,L]
</Location>

    <IfModule mod_proxy.c>
        ProxyRequests off
        #ProxyPreserveHost On
        
        #ProxyPass /api/websocket ws://portainer_container:9000/api/websocket enablereuse=Off nocanon
        #ProxyPassReverse /api/websocket ws://portainer_container:9000/api/websocket
        
        #ProxyPass / http://portainer_container:9000/ enablereuse=Off nocanon
        #ProxyPassReverse / http://portainer_container:9000/
    </IfModule>

    <IfModule mod_rewrite.c>
        #RewriteEngine on
        
        # Redirect to https
        #RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    </IfModule>

    # Log
    LogLevel error
    ErrorLog /home/${WWW_USER_NAME}/root${WEB_PATH}portainer_error.log
    #CustomLog /home/${WWW_USER_NAME}/root${WEB_PATH}portainer_custom.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerAdmin ${WWW_USER_NAME}@${DOMAIN}
    ServerName portainer.${DOMAIN}
    ServerAlias portainer.${DOMAIN}

ProxyPreserveHost On
ProxyPass / http://portainer_container:9000/
ProxyPassReverse / http://portainer_container:9000/
RequestHeader set X-Forwarded-Proto "https"

ProxyVia Block

<Proxy *>
Require all granted
</Proxy>

Header set X-Content-Type-Options "nosniff"

<Location /api/websocket/>
RewriteEngine on
RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC]
RewriteCond %{HTTP:CONNECTION} Upgrade$ [NC]
RewriteRule /api/websocket/(.*) ws://portainer_container:9000/api/websocket/$1 [P]
</Location>

    <IfModule mod_proxy.c>
        #ProxyRequests off
        #ProxyPreserveHost On

        #ProxyPass /api/websocket ws://portainer_container:9000/api/websocket enablereuse=Off nocanon
        #ProxyPassReverse /api/websocket ws://portainer_container:9000/api/websocket
        
        #ProxyPass / https://portainer_container:9000/ enablereuse=Off nocanon
        #ProxyPassReverse / https://portainer_container:9000/
    </IfModule>

    <IfModule mod_rewrite.c>
        #RewriteEngine on
        
        #RewriteCond ${HTTP:Upgrade} websocket [NC]
        #RewriteCond ${HTTP:Connection} upgrade [NC]
        #RewriteRule .* "wss:/portainer_container:9000/$1" [P,L]
    </IfModule>

    <IfModule mod_ssl.c>
        SSLEngine on
        SSLProxyEngine on
        SSLProxyVerify none
        SSLProxyCheckPeerCN off
        SSLProxyCheckPeerName off
        SSLProxyCheckPeerExpire off

        SSLCertificateFile /home/${WWW_USER_NAME}/root/certificate/${CERTIFICATE_FILE}
        SSLCertificateKeyFile /home/${WWW_USER_NAME}/root/certificate/${CERTIFICATE_KEY}
        SSLCertificateChainFile /home/${WWW_USER_NAME}/root/certificate/${CERTIFICATE_CHAIN}
    </IfModule>
    
    # Log
    #LogLevel info mod_ssl.c:debug
    LogLevel error
    ErrorLog /home/${WWW_USER_NAME}/root${WEB_PATH}portainer_error.log
    #CustomLog /home/${WWW_USER_NAME}/root${WEB_PATH}portainer_custom.log combined
</VirtualHost>

SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder off
SSLSessionTickets off
SSLUseStapling on
SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"